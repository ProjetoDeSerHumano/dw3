{% extends "templates/base.html" %}

{% block content %}
  <div class="row justify-content-center" x-data="loginForm()">
    <div class="col-xl-5 col-lg-6 col-md-8">
      
      <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">{{title}}</li>
      </ol>
      
      <div class="card shadow-lg border-0 rounded-lg mt-5">
        <div class="card-header"><h3 class="text-center font-weight-light my-4">Acesso ao Sistema</h3></div>
        
        <div class="card-body">
          <form @submit.prevent="submitForm">
            
            <div class="form-group mb-3">
              <label class="small mb-1" for="inputUsername">Usuário</label>
              <input 
                class="form-control" 
                id="inputUsername" 
                type="text" 
                placeholder="Digite seu nome de usuário"
                x-model="form.username"
                required
              />
            </div>
            
            <div class="form-group mb-4">
              <label class="small mb-1" for="inputPassword">Senha</label>
              <input 
                class="form-control" 
                id="inputPassword" 
                type="password" 
                placeholder="Digite sua senha"
                x-model="form.password"
                required
              />
            </div>
            
            <div class="d-flex align-items-center justify-content-between mt-4 mb-0">
              <button type="submit" class="btn btn-primary w-100" :disabled="loading">
                <span x-show="loading" class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                <span x-text="loading ? 'Entrando...' : 'Entrar'"></span>
              </button>
            </div>

          </form>
        </div>
        
        <div class="card-footer text-center py-3">
          <template x-if="message">
            <div :class="messageClass" x-text="message" role="alert"></div>
          </template>
        </div>
      </div>
    </div>
  </div>

<script>
  window.onload = function () {
    windowOnLoad();
  };

  function loginForm() {
    return {
      form: {
        username: '',
        password: '',
      },
      message: '',
      messageClass: '',
      loading: false,

      async submitForm() {
        this.message = '';
        this.loading = true;

        try {
          const response = await fetch('/login', { // Rota Front-End que chama ctlLogin.LoginUsuario
            method: 'POST',
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(this.form)
          });

          const result = await response.json();
          this.loading = false;
          
          if (result.status === "ok") {
            this.message = 'Login bem-sucedido! Redirecionando...';
            this.messageClass = 'alert alert-success';
            
            // Redirecionar para a página inicial ou de Manutenção de Contas
            window.location.href = "/contas/manutContas"; 
            
          } else {
            const errorMsg = result.msg || "Credenciais inválidas. Tente novamente.";
            this.message = `Erro ao logar: ${errorMsg}`;
            this.messageClass = 'alert alert-danger';
          }

        } catch (error) {
          this.loading = false;
          this.message = `Erro de conexão. Verifique o servidor.`;
          this.messageClass = 'alert alert-danger';
          console.error('Login error:', error);
        }
      },
    };
  }
</script>


{% endblock %}